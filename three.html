<!DOCTYPE html>
<html>

<head>
	<title>跟着音乐舞动起来吧！！</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=750,user-scalable=no">
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
		}

		body {
			overflow: hidden;
		}
	</style>

	<script>
		document.addEventListener('touchmove',function(e){
			e.preventDefault();
			return false;
		})
	</script>
</head>

<body>

	<audio src="./music/1.m4a" id='audio'></audio>

	<script src='https://threejs.org/build/three.js'></script>
	<script>


		(function(document){

			var util = {
				init(){

					this.loadMusic();
					this.initThreeJs();


				},
				viewW:window.innerWidth,
				viewH:window.innerHeight,
				particles:[],
				arr:[],
				initThreeJs(){
					var { particles,viewW,viewH, arr, analyser} = this;
					var windowHalfX = viewW / 2;
					var windowHalfY = viewH / 2;
					var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
					camera.position.z = 1000;
					var scene = new THREE.Scene();
					var SEPARATION = 100;
					var AMOUNTX = 20;
					var AMOUNTY = 20;
					var mouseX = mouseY = 0;
					for (var ix = 0; ix < AMOUNTX; ix++) {
						for (var iy = 0; iy < AMOUNTY; iy++) {
							var random = Math.random;
							var lineGeo = new THREE.BufferGeometry();
							lineGeo.attributes.position = new THREE.BufferAttribute(new Float32Array([
								ix * SEPARATION - ((AMOUNTX * SEPARATION) / 2),
								0,
								iy * SEPARATION - ((AMOUNTY * SEPARATION) / 2),
								ix * SEPARATION - ((AMOUNTX * SEPARATION) / 2),
								30,
								iy * SEPARATION - ((AMOUNTY * SEPARATION) / 2),
							]), 3);

							lineGeo.attributes.color = new THREE.BufferAttribute(new Float32Array([
								1, 1, 1,
								1, 0, 1
							]), 3);
							var material = new THREE.LineBasicMaterial({
								vertexColors: THREE.VertexColors
							});

							particle = new THREE.Line(lineGeo, material);
							particles.push(particle);
							scene.add(particle);
						}
					}
					renderer = new THREE.WebGLRenderer();
					renderer.setPixelRatio(window.devicePixelRatio);
					renderer.setSize(window.innerWidth, window.innerHeight);
					document.body.appendChild(renderer.domElement);
					document.addEventListener('mousemove', onDocumentMouseMove, false);
					document.addEventListener('touchstart', onDocumentTouchStart, false);
					document.addEventListener('touchmove', onDocumentTouchMove, false);

					function onDocumentMouseMove(event) {
						mouseX = event.clientX - windowHalfX;
						mouseY = event.clientY - windowHalfY;
					}
					function onDocumentTouchStart(event) {
						if (event.touches.length > 1) {
							event.preventDefault();
							mouseX = event.touches[0].pageX - windowHalfX;
							mouseY = event.touches[0].pageY - windowHalfY;
						}
					}
					function onDocumentTouchMove(event) {
						if (event.touches.length == 1) {
							event.preventDefault();
							mouseX = event.touches[0].pageX - windowHalfX;
							mouseY = event.touches[0].pageY - windowHalfY;
						}
					}
					
					(function render(){
						requestAnimationFrame(render);
						camera.position.x += (mouseX - camera.position.x) * .05;
						camera.position.y += (- mouseY - camera.position.y) * .05;
						camera.lookAt(scene.position);
						renderer.render(scene, camera);
						if (arr.length) {
							analyser.getByteFrequencyData(arr);
							particles.forEach(function (item, i) {
								item.scale.y = Math.max(arr[i] / 30, 1);
							})
						}
					})();
					
					

				},
				loadMusic(){
				
					var oAudio = document.getElementById('audio');
					var ac = new (window.AudioContext || window.webkitAudioContext)();

					oAudio.play();

					// 创建媒体源,除了audio本身可以获取，也可以通过oCtx对象提供的api进行媒体源操作
					//
					var audioSrc = ac.createMediaElementSource(oAudio);
					// 创建分析机 
					var analyser = ac.createAnalyser();
					this.analyser = analyser;
					// 媒体源与分析机连接
					audioSrc.connect(analyser);
					// 输出的目标：将分析机分析出来的处理结果与目标点（耳机/扬声器）连接
					analyser.connect(ac.destination);
					
					analyser.fftSize = 1024;
					///console.log(analyser.frequencyBinCount,'analyser.frequencyBinCount')
					this.arr = new Uint8Array(analyser.frequencyBinCount)
				}

			};

			util.init()
		})(document);
	 
	</script>
</body>

</html>